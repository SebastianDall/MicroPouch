---
title: "barcode_link"
author: "Sebastian MÃ¸lvang Dall"
date: "28/4/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading links

```{r}
library(tidyverse)
library(readxl)
library(janitor)
```


```{r}
theme_cos = theme_bw() + 
  theme(panel.grid  = element_blank(),
        legend.position = "none",
        axis.title = element_blank())
```

# Barcode_sheet
I know the barcode for each sample, since this was done by June and Sabrina. Firstly, I load all the barcodes and their respective sample name.


## PaPr
```{r}
PaPr_sheet <- read_delim("../data/barcodes_sheet/csv/PaPr_barcodes.csv", delim = ",") %>%
  fill(patient_number) %>%
  mutate(patient_number = as.character(patient_number),
         patient_number = ifelse(nchar(patient_number) == 1, paste0("pt00",patient_number), paste0("pt0",patient_number)))
```

## DoBa
```{r}
DoBa_sheet <- read_delim("../data/barcodes_sheet/csv/DoBa_barcodes.csv", delim = ",") %>%
  fill(donor_number) %>%
  mutate(donor_number = as.character(donor_number),
         donor_number = ifelse(nchar(donor_number) == 2, paste0("do0",donor_number),
                               ifelse(grepl("Asym",barcode), paste0("Asym00", donor_number), paste0("do00",donor_number))))
```

## PaNP
```{r}
PaNP_sheet <- read_delim("../data/barcodes_sheet/csv/PaNP_barcodes.csv", delim = ",") %>%
  fill(patient_number) %>%
  mutate(patient_number = as.character(patient_number),
         patient_number = ifelse(nchar(patient_number) == 1, paste0("pt00",patient_number), paste0("pt0",patient_number)))
```

## PaOp
```{r}
PaOp_sheet <- read_delim("../data/barcodes_sheet/csv/PaOp_barcodes.csv", delim = ",") %>%
  fill(patient_number) %>%
  mutate(patient_number = as.character(patient_number),
         patient_number = ifelse(nchar(patient_number) == 1, paste0("pt00",patient_number), paste0("pt0",patient_number)))
```

## DoSc
```{r}
DoSc_sheet <- read_delim("../data/barcodes_sheet/csv/DoSc_barcodes.csv", delim = ",") %>%
  fill(donor_number) %>%
  mutate(donor_number = as.character(donor_number),
         donor_number = ifelse(nchar(donor_number) == 2, paste0("do0",donor_number),
                               ifelse(grepl("Asym", donor_number), gsub("p ", "", donor_number), paste0("do00",donor_number))))
```

### Binding Sheets

Here I concatenate all the respective barcode sheets.

```{r}
barcode_metadata <- bind_rows(PaPr_sheet, PaNP_sheet, PaOp_sheet, DoBa_sheet, DoSc_sheet) %>%
  mutate(barcode_clean = gsub("MTKF ","", barcode),
         barcode_clean = paste0(barcode_clean,"MP"),
         donor_number = ifelse(grepl("Asym004",donor_number), "asym004",donor_number))


#write_csv(barcode_metadata, file = "../data/metadata/csv/barcode_metadata.csv")
```



# Tube barcode - Sample/TS/EXT/POS barcode link

```{r}
barcode_metadata <- read.csv("../data/metadata/csv/barcode_metadata.csv")
```

The following files are the files for link between barcode and extraction tube (files_l), the temporary racks (files_TS), the extraction racks (files_ext), and the rack with positive control.

```{r}
files_l <- list.files("../data/tube_barcode/", full.names = T, pattern = "*.xls")
files_TS <- list.files("../data/TS_barcode/", full.names = T, pattern = "*.xls")
files_ext <- list.files("../data/EXT_barcode/", full.names = T, pattern = "*.xls")
files_pos <- list.files("../data/EXT_pos/", full.names = T, pattern = "*.xls")


```


# Sample Tubes
opening all the excel files one by one.

```{r}
link <- tibble(rack_barcode = NA, tube_barcode = NA)

for (f in files_l) {
  d <- read_excel(path = f) %>% as_tibble()
  d_tmp <- d %>%
    clean_names() %>%
    filter(row_number() == 1)

  stopifnot(!d_tmp$rack_barcode %in% link$rack_barcode) #checks if rack barcode is already in link (must not)
  stopifnot(!d_tmp$tube_barcode %in% link$tube_barcode) #chekcs if tube barcode is already in link (must not)
  stopifnot(d_tmp$rack_barcode %in% barcode_metadata$barcode_clean) #checks if sample barcode is in barcode_metadata (must be) 

  link <- bind_rows(link,d_tmp)
}

link <- link %>%
  filter(!is.na(rack_barcode))

```


# TS rack

```{r}
TS <- tibble(rack_barcode = NA, tube_barcode = NA)

for (f in files_TS) {
  d <- read_excel(path = f) %>% as_tibble()
  d_tmp <- d %>%
    clean_names() %>%
    filter(tube_barcode != "EMPTY")

  stopifnot(!d_tmp$rack_barcode[1] %in% TS$rack_barcode)
  stopifnot(!d_tmp$tube_barcode %in% TS$tube_barcode)

  TS <- bind_rows(TS,d_tmp)
}

TS <- TS %>%
  filter(!is.na(rack_barcode))

```


# Extraction rack

```{r}
ext <- tibble(rack_barcode = NA, tube_barcode = NA)

for (f in files_ext) {
  d <- read_excel(path = f) %>% as_tibble()
  d_tmp <- d %>%
    clean_names() %>%
    filter(tube_barcode != "EMPTY")

  stopifnot(!d_tmp$rack_barcode[1] %in% ext$rack_barcode)
  stopifnot(!d_tmp$tube_barcode %in% ext$tube_barcode)

  ext <- bind_rows(ext,d_tmp)
}

ext <- ext %>%
  filter(!is.na(rack_barcode))

```



# Positive Control

Adds the positive control to link.

```{r}
pos_file <- grep("EXT_POS", files_pos, value = T)

pos <- read_excel(path = pos_file) %>% 
  as_tibble() %>%
  clean_names() %>%
  mutate(tube_barcode = as.character(tube_barcode),
         tube_barcode = paste0("0",tube_barcode))

pos_link <- bind_rows(link, pos)
```



## left_join TS

```{r}
TS_link <- link %>%
  select(tube_barcode, rack_barcode) %>%
  rename(sample_barcode = rack_barcode) %>%
  left_join(TS, by = "tube_barcode") %>%
  filter(!is.na(rack_barcode))

```


## left_join EXT
This one contains the barcode

```{r}
ext_link <- pos_link %>%
  select(tube_barcode, rack_barcode) %>%
  rename(sample_barcode = rack_barcode) %>%
  left_join(ext, by = "tube_barcode") %>%
  filter(!is.na(rack_barcode))
```



# Check positive controls


```{r}
ext_pos <- ext_link %>%
  filter(tube_row == "D" & tube_column == 12)

stopifnot(ext_pos$tube_barcode %in% pos$tube_barcode)
```



## Plot TS_links


```{r}

TS_link %>%
  mutate(tube_row = fct_rev(as.factor(tube_row)),
         tube_column = as.factor(tube_column)) %>%
  ggplot(aes(x = tube_column, y = tube_row, fill = rack_barcode)) + 
  geom_tile(color = "white") + 
  facet_wrap(.~rack_barcode) +
  scale_x_discrete(expand = c(0, 0),position = 'top') +
  theme_cos

```

```{r}

all_barcodes <- bind_rows(TS_link, ext_link)

missing <- barcode_metadata %>%
  filter(!barcode_clean %in% all_barcodes$sample_barcode)

```


## Plot ext_links

```{r}

ext_link %>%
  mutate(tube_row = fct_rev(as.factor(tube_row)),
         tube_column = as.factor(tube_column)) %>%
  ggplot(aes(x = tube_column, y = tube_row, fill = rack_barcode)) + 
  geom_tile(color = "white") +
  facet_wrap(.~rack_barcode) +
  scale_x_discrete(expand = c(0, 0),position = 'top') +
  theme_cos
```


## filter negative controls from ext
For EXT00003 only the negatives in column 10 are used. This is because the failed extraction of col 1-8 in EXT00003.

```{r}

neg <- ext %>%
  filter(tube_row %in% c("C", "F") & tube_column %in% c(3,10)) %>%
  filter(ifelse(rack_barcode == "EXT00003", tube_column != 3, tube_column == tube_column)) %>% 
  group_by(rack_barcode) %>% 
  mutate(id = row_number()) %>%
  mutate(sample_barcode = paste0("NEG_",id)) %>% 
  select(-id)

```

## join barcode_metadata and extraction position

* rename extraction positives
* add negative controls.
* write csv file

```{r}
d_ext <- barcode_metadata %>%
  rename(sample_barcode = barcode_clean) %>%
  full_join(ext_link, by = "sample_barcode") %>%
  unite("person", c(patient_number,donor_number), na.rm = T) %>%
  unite("batch_number", c(fecal_donation_number,batch_donation_number), na.rm = T) %>% 
  mutate(sample_barcode = ifelse(sample_barcode == "TS00017776", paste0("EXT_POS"), sample_barcode)) %>% 
  bind_rows(neg)



#write_csv(d_ext, file = "../data/barcodes_sheet/csv/ext_link.csv")
```




```{r}
d_ext %>% 
  group_by(rack_barcode) %>% 
  summarise(sample = n())
```








