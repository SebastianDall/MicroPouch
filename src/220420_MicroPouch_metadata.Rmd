---
title: "220420_MicroPouch_Cleaning_metadata"
author: "Sebastian Mølvang Dall"
date: "20/4/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Data

```{r}
library(tidyverse)
library(janitor)
library(ggpubr)
```



## Redcap metadata

Loading metadata csv files - downloaded from REDcap

>> There are discrepencies between redcap and downloaded csv file!!


```{r}
metadata <- read_delim("../data/metadata/MicroPouch_DATA_2022-06-21_1300.csv", delim = ";") %>% 
  mutate(project = "MP") %>% 
  fill(randomization_group)

metadata_op <- read_delim("../data/metadata/MicroPouchOpen_DATA_2022-06-21_1303.csv", delim = ";") %>% 
  mutate(project = "OP") %>% #For patient 007 the pdai score is duplicated
  mutate(pdai_c1 = NA,
         pdai_c2 = NA,
         pdai_c3 = NA,
         pdai_c4 = NA)

metadata_np <- read_delim("../data/metadata/MicroPouchNP_DATA_2022-06-21_1303.csv", delim = ";") %>% 
  mutate(project = "NP") %>% 
  mutate(pdai_c1 = NA,
         pdai_c2 = NA,
         pdai_c3 = NA,
         pdai_c4 = NA) %>% 
  rename(study_id = record_id)
```



### Joining the 3 datasets

All projects are concatenated into one variable. The projects are distinguished by the `project` variable.

```{r}
m_all <- bind_rows(metadata, metadata_op, metadata_np) %>% 
  arrange(study_id) %>% 
  relocate(project, .after = study_id)
```



```{r}
group <- metadata %>%
  select(study_id, randomization_group) %>%
  filter(!is.na(randomization_group)) %>%
  mutate(group = ifelse(randomization_group==0, "FMT", "placebo"),
         patient = paste0("pt",study_id),
         project = "MP") %>% 
  select(-study_id, -randomization_group)
```


### Renaming columns
* selecting relevant pouch data
* uniting "duplicate" pdai columns

the there are two versions of pdai questionnaire in the dataset. One from the inklusion and followup with pouch inspection, and one from the different treatment dates.


```{r}
m_sel <- m_all %>% 
  select(study_id, project, randomization_group, redcap_event_name, 
         contains("pdai"), starts_with("pouchdys"), starts_with("sibdq"),
         starts_with("diet")) %>% 
  unite('pdai_c1', c(pdai_c1, cpdai_c1), remove = T, na.rm = T) %>% 
  unite('pdai_c2', c(pdai_c2, cpdai_c2), remove = T, na.rm = T) %>% 
  unite('pdai_c3', c(pdai_c3, cpdai_c3), remove = T, na.rm = T) %>%
  unite('pdai_c4', c(pdai_c4, cpdai_c4), remove = T, na.rm = T) %>% 
  unite('pdai_complete', c(pdai_complete, cpdai_complete), remove = T, na.rm = T) %>% 
  unite('pdai_date', c(pdai_date, cpdai_date), remove = T, na.rm = T)
  
```


#### Calculating pdai score and add to m_p
* **The score is not calculated for "OP" since the pdai_e and h is not completed**

>> The pdai score does **NOT** match with redcap for events outside inclusion and 30day followup. 

```{r}
m_pdai <- m_sel %>% 
  select(study_id, project, redcap_event_name, randomization_group, 
         starts_with("pdai"), -pdai_complete, -pdai_date) %>% 
  #filter(redcap_event_name %in% c("inclusion_arm_1", "followup_30day_arm_1")) %>% 
  filter(redcap_event_name %in% c("inclusion_arm_1", "followup_30day_arm_1")) %>% 
  mutate_at(vars(matches("pdai_c")), as.numeric) %>% 
  mutate(randomization_group = if_else(randomization_group == 0, "FMT", "placebo")) %>% 
  fill(randomization_group) %>% 
  group_by(study_id, redcap_event_name) %>% 
  replace(is.na(.), 0) %>% 
  mutate(pdai_score = rowSums(across(where(is.numeric)))) %>% 
  select(study_id, project, redcap_event_name, pdai_score) %>% 
  right_join(m_sel, by = c("study_id", "redcap_event_name", "project")) %>% 
  arrange(study_id)
  
```



#### Deselecting irrelevant columns
* Some columns contains irrelevant information such as height and age in the diet questionnaire.

> deselect "complete" and "date column".

```{r}
m_rel <- m_pdai %>% 
  select(-c(diet_date:diet_q1b),
         -c(diet_q3:diet_q7)
         
         )
```



### Changing column values
* All values are stored as integer answers. Here these are recoded for better overview. It should be considered whether this is a good idea or if they should be factored instead.


```{r}
m_v <- m_rel %>% 
  mutate(
    pouchdys_q2 = recode(pouchdys_q2, `0` = "<1", `1` = "1-3", `2` = "4-7", `3` = "8-10", `4` = ">10"),
    pouchdys_q3 = recode(pouchdys_q2, `0` = "0", `1` = "<1", `2` = "1-2", `3` = ">2"),
    pouchdys_q4 = recode(pouchdys_q4, `0` = "shaped", `1` = "pourridge", `2` = "watery"),
    pouchdys_q5 = recode(pouchdys_q5, `1` = "yes", `0` = "no"),
    pouchdys_q6 = recode(pouchdys_q6, `0` = "<1", `1` = "1-3", `2` = "4-7", `3` = "8-10", `4` = ">10"),
    pouchdys_q7 = recode(pouchdys_q7, `0` = ">60", `1` = "60", `2` = "30", `3` = "15", `4` = "5"),
    pouchdys_q8 = recode(pouchdys_q8, `0` = "0", `1` = "<1", `2` = "1-2", `3` = "3-4", `4` = ">4"),
    pouchdys_q9 = recode(pouchdys_q9, `0` = "0", `1` = "<1", `2` = "1-2", `3` = "3-4", `4` = ">4"),
    pouchdys_q10 = recode(pouchdys_q10, `0` = "0", `1` = "<1", `2` = "1-2", `3` = "3-4", `4` = ">4"),
    pouchdys_q11 = recode(pouchdys_q11, `1` = "yes", `0` = "no"),
    pouchdys_q12 = recode(pouchdys_q12, `1` = "yes", `0` = "no"),
    pouchdys_q13 = recode(pouchdys_q13, `1` = "yes", `0` = "no"),
    pouchdys_q14 = recode(pouchdys_q14, `0` = "none", `1` = "little", `2` = "much", `3` = "very much"),
    sibdq_q1 = recode(sibdq_q1, 
                      `1` = "all the time",
                      `2` = "most of the time",
                      `3` = "good portion of the time",
                      `4` = "some of the time",
                      `5` = "little of the time",
                      `6` = "nearly nothing of the time",
                      `7` = "nothing of the time"),
    sibdq_q2 = recode(sibdq_q2, 
                      `1` = "all the time",
                      `2` = "most of the time",
                      `3` = "good portion of the time",
                      `4` = "some of the time",
                      `5` = "little of the time",
                      `6` = "nearly nothing of the time",
                      `7` = "nothing of the time"),
    sibdq_q3 = recode(sibdq_q3, 
                      `1` = "impossible",
                      `2` = "whole lot of trouble",
                      `3` = "lot of trouble",
                      `4` = "some trouble",
                      `5` = "little trouble",
                      `6` = "nearly no trouble",
                      `7` = "no trouble"),
     sibdq_q4 = recode(sibdq_q4, 
                      `1` = "all the time",
                      `2` = "most of the time",
                      `3` = "good portion of the time",
                      `4` = "some of the time",
                      `5` = "little of the time",
                      `6` = "nearly nothing of the time",
                      `7` = "nothing of the time"),
     sibdq_q5 = recode(sibdq_q5, 
                      `1` = "all the time",
                      `2` = "most of the time",
                      `3` = "good portion of the time",
                      `4` = "some of the time",
                      `5` = "little of the time",
                      `6` = "nearly nothing of the time",
                      `7` = "nothing of the time"),
     sibdq_q6 = recode(sibdq_q6, 
                      `1` = "very big problem",
                      `2` = "big problem",
                      `3` = "noticeable problem",
                      `4` = "some problems",
                      `5` = "few problems",
                      `6` = "nearly no problems",
                      `7` = "no problem"),
    sibdq_q7 = recode(sibdq_q7, 
                      `1` = "very big problem",
                      `2` = "big problem",
                      `3` = "noticeable problem",
                      `4` = "some problems",
                      `5` = "few problems",
                      `6` = "nearly no problems",
                      `7` = "no problem"),
    sibdq_q8 = recode(sibdq_q8, #  ORDER REVERSED!
                      `7` = "all the time",
                      `6` = "most of the time",
                      `5` = "good portion of the time",
                      `4` = "some of the time",
                      `3` = "little of the time",
                      `2` = "nearly nothing of the time",
                      `1` = "nothing of the time"),
    
    sibdq_q9 = recode(sibdq_q9, 
                      `1` = "all the time",
                      `2` = "most of the time",
                      `3` = "good portion of the time",
                      `4` = "some of the time",
                      `5` = "little of the time",
                      `6` = "nearly nothing of the time",
                      `7` = "nothing of the time"),
    sibdq_q10 = recode(sibdq_q10, 
                      `1` = "all the time",
                      `2` = "most of the time",
                      `3` = "good portion of the time",
                      `4` = "some of the time",
                      `5` = "little of the time",
                      `6` = "nearly nothing of the time",
                      `7` = "nothing of the time"),
    diet_q2 = recode(diet_q2,
                     `1` = "primary school (<10yrs)",
                     `2` = "vocational education",
                     `3` = "higher preparatory exam",
                     `4` = "short-cycle higher education",
                     `5` = "medium-cycle higher education",
                     `6` = "long cycle higher education"
                     ),
    diet_q8 = recode(diet_q8,
                     `1` = "smør",
                     `2` = "Kærgården, Bakkedal, Marklyst, Mælkebytte, Lurpak smørbar",
                     `3` = "Plantemargarine 60-80% (i bæger af 400g)",
                     `4` = "Minarine (Lätta, Becal 38%)",
                     `5` = "Becel Pro-Activ",
                     `6` = "Margarine 70-80% (i papirpakke a 500 g)",
                     `7` = "Fedt (svinefedt, andefedt, kokosfedt)",
                     `8` = "Bruger ikke fedtstof på brødet",
                     `9` = "Ved ikke"
                     ),
    diet_q9 = recode(diet_q9,
                     `1` = "smør",
                     `2` = "Kærgården, Bakkedal, Marklyst, Mælkebytte, Lurpak smørbar",
                     `3` = "Plantemargarine 60-80% (i bæger af 400g)",
                     `4` = "Minarine (Lätta, Becal 38%)",
                     `5` = "Becel Pro-Activ",
                     `6` = "Margarine 70-80% (i papirpakke a 500 g)",
                     `7` = "Fedt (svinefedt, andefedt, kokosfedt)",
                     `8` = "Bruger ikke fedtstof på brødet",
                     `9` = "Ved ikke"
                     ),
    diet_q11_1 = recode(diet_q11_1,
                        `1` = "daily",
                        `2` = "weekly",
                        `3` = "monthly",
                        `4` = "rarely"
                        ),
    #diet_q11_1a = recode(diet_q11_1a,
    #                     )
    

    
    #pdai_c1 = recode(pdai_c1, `0` = "pou", `1` = "1-2>po", `2` = "+3>pou"), #pou: Post-operative usual
         #pdai_c2 = recode(pdai_c2, `0` = "never/rarely", `1` = "Daily"),
         #pdai_c3 = recode(pdai_c3, `0` = "none", `1` = "occational", `2` = "usual"),
         #pdai_c4 = recode(pdai_c4, `0` = "absent", `1` = "present"),
         #pdai_e___1 = recode(pdai_e___1,)
    
         )
```



* giving more indicative names to columns

```{r}
m_i <- m_v %>% 
  rename(
    #pdai
    pdai_stool_frequency = pdai_c1,
    pdai_rectal_bleeding = pdai_c2,
    pdai_bowel_abdominal = pdai_c3,
    pdai_fever = pdai_c4,
    pdai_edema = pdai_e___1,
    pdai_granularity = pdai_e___2,
    pdai_friability = pdai_e___3,
    pdai_vp_loss = pdai_e___4,
    pdai_mucosal_exudate = pdai_e___5,
    pdai_ulcerations = pdai_e___6,
    #pouch function (pf)
    pf_defecations_per_day = pouchdys_q1,
    pf_defecations_day = pouchdys_q2,
    pf_defecations_night = pouchdys_q3,
    pf_stool_consistency = pouchdys_q4,
    pf_urge_to_defecate = pouchdys_q5,
    pf_urgent_defecations_per_day = pouchdys_q6,
    pf_hold_back_time = pouchdys_q7,
    pf_leakages_per_day = pouchdys_q8,
    pf_uncontrolled_defecations_per_day = pouchdys_q9,
    pf_incomplete_defecations_per_day = pouchdys_q10,
    pf_diaper = pouchdys_q11,
    pf_anti_diarrhea_medicine = pouchdys_q12,
    pf_antibiotics = pouchdys_q13,
    pf_health_affect = pouchdys_q14
    #sibdq
    
  )
```

### mutate and rename columns for joining later

This chunk prepares the dataframe to be concatenated with the lab-metadata later.
* Patient name is changed.
* redcap_event_name variables are renamed.
* randomization_group (placebo, FMT) is changed and renamed group.

This dataframe is going to be concatenated with the lab metadata.

```{r}
m_tmp <- m_i %>% 
  ungroup() %>% 
  # Changing study_id tags
  mutate(study_id = paste0("pt", study_id),
         # Renaming event names
         redcap_event_name = str_replace(redcap_event_name, "\\_arm\\_1", ""), 
         
  ) %>% 
  # Changing treatment variables in recap_event_name
  mutate(
    sub_label = stringr::str_split(redcap_event_name, "_"),
    tmp_label = paste0(map_if(.x = sub_label, .p = ~is.vector(.x), 2), "_", map_if(.x = sub_label, .p=~is.vector(.x), 1)),
    redcap_event_name = if_else(str_detect(tmp_label, "treatment"), tmp_label, redcap_event_name)
  ) %>%
  # Changing followup in redcap_event_name
  mutate(
    redcap_event_name = str_replace(redcap_event_name, "\\_days", "d"),
    redcap_event_name = str_replace(redcap_event_name, "day", "d"),
    redcap_event_name = str_replace(redcap_event_name, "\\_months", "m"),
    redcap_event_name = str_replace(redcap_event_name, "\\_month", "m"),
    redcap_event_name = str_replace(redcap_event_name, "\\_p", ""),
    redcap_event_name = str_replace(redcap_event_name, "follow\\_up", "followup")
  ) %>% 
  rename(
    id = study_id,
    stage = redcap_event_name
    
  ) %>% 
  mutate(randomization_group = recode(randomization_group,
                                      `0` = "FMT",
                                      `1` = "placebo"),
         randomization_group = replace_na(randomization_group, "FMT")
         ) %>% 
  rename(group = randomization_group)
```


## Donor Batch Overview and Barcode
### Load Barcodes
```{r}
barcode_metadata <- read_csv("../data/metadata/csv/barcode_metadata.csv")
```



### Overview

A donor batch is associated with a date and a donor number
```{r}
DoBa_overview <- read_csv("../data/metadata/csv/DoBa_oversigt.csv")

DoBa_o_c <- DoBa_overview %>%
  mutate(Donor = gsub("MTKF ", "do", Donor),
         Donor = gsub(" ","_",Donor))

DoBa_o_c <- DoBa_overview %>%
  mutate(Donor = gsub("MTKF ", "", Donor),
         Donor = ifelse(nchar(Donor) > 3, "asym004", paste0("do",Donor)))


DoBa_o_l <- DoBa_o_c %>%
  pivot_longer(cols = !Donor, names_to = c("batch_donation_number"),
               values_to = "batch_name") %>%
  mutate(batch_donation_number = gsub(".donation", "", batch_donation_number),
         batch_donation_number = as.numeric(batch_donation_number)) %>%
  filter(!is.na(batch_name)) %>%
  rename(donor_number = Donor)

```




* Match donor names with `DoBa_o_c`
```{r}
DoBa <- barcode_metadata %>%
  select(donor_number, batch_donation_number, barcode_clean) %>%
  full_join(DoBa_o_l, by = c("donor_number", "batch_donation_number")) %>%
  filter(!is.na(batch_donation_number)) %>%
  mutate(batch_name = paste0("(",batch_name,")"))

#write_csv(DoBa, file = "../data/metadata/csv/DoBa_bo.csv")
```




## Donor and patient match overview

>**The last mutate corrects a date for do020 batch (17.09.19) corrected from (17.19.19)**


```{r}
PaDo_overview <- read_csv("../data/metadata/MicroPouch patient donor batch oversigt april2022.csv")

PaDo_c <- PaDo_overview %>%
  mutate(MicroPouch_NP = ifelse(grepl("(np)", Patient),T, F),
         MicroPouch_open = ifelse(grepl("(o)", Patient),T, F),
         ) %>%
  mutate(Patient = gsub(pattern = "[[:punct:]]np[[:punct:]]",replacement = "",x = Patient),
         Patient = gsub(pattern = "[[:punct:]]o[[:punct:]]",replacement = "",x = Patient),
         Patient = gsub(pattern = " ", replacement = "", x = Patient))

PaDo_l <- PaDo_c %>%
  pivot_longer(Donor_1_batch_1:Donor_4_batch_2, names_to = "donor_batch", values_to = "batch") %>%
  filter(!is.na(batch)) %>% 
  separate_rows(batch, sep = " ") %>%
  mutate(cat = ifelse(nchar(batch) == 10, "batch", "donor")) %>%
  pivot_wider(names_from = cat, values_from = batch) %>%
  mutate(donor = ifelse(donor != "asymp004", paste0("do",donor), "asym004"),
         study = ifelse(MicroPouch_NP, "NP",
                        ifelse(MicroPouch_open, "OP", "MP"))) %>%
  select(-c(MicroPouch_NP, MicroPouch_open)) %>%
  mutate(batch = ifelse(test = grepl("do020", donor), yes = ifelse(test = grepl("(17.19.19)", batch), yes = "(17.09.19)", no = batch), no = batch)) # Error in patient data overview.csv

#write_csv(PaDo_c,"../data/metadata/csv/PatientDonor_match.csv")

```


## Join information in DoBa and PaDo
This will create a dataframe for donor batch connection. 

```{r}
d_pado <- DoBa %>%
  rename(batch = batch_name, donor = donor_number) %>%
  full_join(PaDo_l, by = c("donor", "batch")) %>% 
  mutate(stage = str_sub(donor_batch, 1,7),
         stage = str_replace(stage, "Donor", "treatment")) %>% 
  mutate(treatment_batch_number = str_sub(donor_batch,9,-1)) %>% 
  mutate(stage = str_replace(stage, "1", "5"),
         stage = str_replace(stage, "2", "10"),
         stage = str_replace(stage, "3", "15"),
         stage = str_replace(stage, "4", "21")
         )
```




# Extraction koncentration and completion of study.

I need to figure out who handed in a fecal sample. Those are the persons with sample_dates in the overview metadata. This has to be done for PaPr, PaOP and PaNP
Thereafter I need to join these tables, and connect them with the EXT_conc file. Lastly I need to make a plot showing each fecal sample and its concentration. This should preferably also be done for donors and screenings.

## PaPr overview

> I have changed value pt001, kontrol30dg, 05.11.1 -> 05.11.19

```{r}
PaPr_overview <- read_csv("../data/metadata/csv/PaPr_overview.csv")


PaPr_c <- PaPr_overview %>%
  mutate(patient = gsub("[a-zA-z]", "", patient),
         patient = gsub("[ -]","",patient),
         patient = paste0("pt",patient)) %>%
  #relocate(Kontrol_30dg, .after = `4_behandling`) %>% 
  clean_names() %>% 
  rename(inclusion = inklusion, 
         treatment_5 = x1_behandling, 
         treatment_10 = x2_behandling,
         treatment_15 = x3_behandling,
         treatment_21 = x4_behandling,
         followup_30d = kontrol_30dg,
         followup_1m = kontrol_1md,
         followup_3m = kontrol_3md,
         followup_6m = kontrol_6md,
         followup_12m = kontrol_12md)

PaPr_l <- PaPr_c %>%
  pivot_longer(-patient, names_to = "stage", values_to = "patient_batch") %>%
  mutate(patient_batch = ifelse(!is.na(patient_batch), paste0("(",patient_batch,")"),patient_batch)) %>%
  mutate(project = "MP") %>% 
  #filter(!is.na(patient_batch)) %>% 
  group_by(patient) %>% 
  mutate(fecal_donation_number = row_number())
```




## PaOP overview

* load
* clean up patient column
* relocate kontrol_30dg
* make long format and change patient_batch.
```{r}
PaOP_overview <- read_csv("../data/metadata/csv/PaOP_overview.csv")


PaOP_c <- PaOP_overview %>%
  mutate(patient = gsub("[a-zA-z]", "", patient),
         patient = gsub("[ -]","",patient),
         patient = paste0("pt",patient)) %>%
  #relocate(Kontrol_30dg, .after = `4_behandling`) %>% 
  rename(kontrol_3md = `Kontrol 3mdr`) %>% 
  clean_names() %>% 
  rename(inclusion = inklusion, 
         treatment_5 = x1_behandling, 
         treatment_10 = x2_behandling,
         treatment_15 = x3_behandling,
         treatment_21 = x4_behandling,
         followup_30d = kontrol_30dg,
         followup_1m = kontrol_1md,
         followup_3m = kontrol_3md)

PaOP_l <- PaOP_c %>%
  pivot_longer(-patient, names_to = "stage", values_to = "patient_batch") %>%
  mutate(patient_batch = ifelse(!is.na(patient_batch), paste0("(",patient_batch,")"),patient_batch)) %>% 
  mutate(project = "OP") %>% 
  group_by(patient) %>% 
  mutate(fecal_donation_number = row_number())
```



## PaNP

* load
* clean up patient column
* make long format and change patient_batch.

```{r}
PaNP_overview <- read_csv("../data/metadata/csv/PaNP_overview.csv")


PaNP_c <- PaNP_overview %>%
  mutate(patient = gsub("[a-zA-z]", "", patient),
         patient = gsub("[ -]","",patient),
         patient = paste0("pt",patient)) %>% 
  clean_names() %>% 
  rename(inclusion = inklusion, 
         treatment_5 = x1_behandling, 
         treatment_10 = x2_behandling,
         treatment_15 = x3_behandling,
         treatment_21 = x4_behandling,
         followup_30d = kontrol_30dg,
         followup_1m = kontrol_1md,
         followup_3m = kontrol_3md,
         followup_6m = kontrol_6md,
         followup_12m = kontrol_12md)

PaNP_l <- PaNP_c %>%
  pivot_longer(-patient, names_to = "stage", values_to = "patient_batch") %>%
  mutate(patient_batch = ifelse(!is.na(patient_batch), paste0("(",patient_batch,")"),patient_batch)) %>% 
  mutate(project = "NP") %>% 
  group_by(patient) %>% 
  mutate(fecal_donation_number = row_number())
```


## Joining the overview tables

Here I join the tables and filter out any patient_batch that was not received.

Change stage names to english

Add the fecal_batch_donation for later left_join

```{r}
stage_fct <- c("inclusion", 
         "treatment_5", 
         "treatment_10",
         "treatment_15",
         "treatment_21",
         "followup_30d",
         "followup_1m",
         "followup_3m",
         "followup_6m",
         "followup_12m",
         "drop_out")

d_overview <- bind_rows(PaPr_l, PaOP_l, PaNP_l) %>% 
  filter(!is.na(patient_batch)) %>% 
  mutate(stage = factor(stage, levels = stage_fct, labels = stage_fct))
```


## add FMT/placebo information

```{r}
group <- metadata %>%
  select(study_id, randomization_group) %>%
  filter(!is.na(randomization_group)) %>%
  mutate(group = ifelse(randomization_group==0, "FMT", "placebo"),
         patient = as.character(study_id),
         patient = if_else(nchar(patient) == 1, paste0("pt00",patient), paste0("pt0",patient)),
         project = "MP") %>% 
  select(-study_id, -randomization_group)
```

## Creating d_pat

ext_conc contains the extraction conc for each sample.

```{r}
ext_conc <- read_csv("../data/metagenomes_lab/220531_metagenome_libraries.csv")

d_ext <- full_join(d_overview, ext_conc, by = c("patient", "fecal_donation_number", "project")) %>% 
  mutate(patient = as.factor(patient),
         patient = fct_rev(patient),
         project = factor(project, levels = c("MP","OP","NP")),
         amount = ext_conc * 80,
         ext_conc = round(ext_conc, 2))

```



```{r}
d_pat_don <- d_ext %>%
  left_join(group, by = c("patient", "project")) %>%
  mutate(group = ifelse(project != "MP", "FMT", group))

```

#### Fill in donor batch information

```{r}

d_fill <- d_pado %>% 
  select(donor, barcode_clean, batch_donation_number, batch) %>% 
  distinct() %>% 
  rename(patient = donor,
         sample_barcode = barcode_clean,
         fecal_donation_number=batch_donation_number,
         donor_batch = batch) %>% 
  right_join(d_ext, by = c("sample_barcode", "patient","fecal_donation_number")) %>% 
  unite("batch", c(patient_batch, donor_batch), na.rm = T)

```



## Donor

```{r}
d_don <- ext_conc %>% 
  filter(is.na(project), !is.na(barcode)) %>% 
  mutate(project = ifelse(grepl("DoSc", sample_barcode), "screening", "FMT_batch"),
         fecal_donation_number = ifelse(is.na(fecal_donation_number), screeningsround -1, fecal_donation_number),
         patient = as.factor(patient)) 
```



### Extraction
```{r}
d_don %>% 
  filter(!is.na(tube_barcode)) %>% 
  mutate(ext_conc = round(ext_conc, 2),
         fecal_donation_number = as.factor(fecal_donation_number)) %>% 
  ggplot(aes(x = fecal_donation_number, y = patient, fill = ext_conc, label = ext_conc)) + 
  geom_tile(color = "white") + 
  geom_text(color = "white") + 
  #scale_color_manual(values = c("white", "red")) + 
  #scale_fill_manual(values = c("chocolate4", "grey69")) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  facet_grid(. ~project, scales = "free_x", space = "free_x") + 
  ggtitle("Main micropouch completion and concentration")
```

#### Illumina library
```{r}
gg_library_donor <- d_don %>% 
  filter(!is.na(tube_barcode)) %>% 
  mutate(pool_ng = round(pool_ng, 2),
         fecal_donation_number = as.factor(fecal_donation_number)) %>% 
  ggplot(aes(x = fecal_donation_number, y = patient, fill = pool_ng, label = pool_ng)) + 
  geom_tile(color = "white") + 
  geom_text(color = "white") + 
  scale_fill_gradient(low = "red4", high = "green4") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  facet_grid(. ~project, scales = "free_x", space = "free_x")
```





## Adding treatment_1-4_donor_batch
```{r}
d_treat <- d_pado %>% 
  select(-c(donor_batch,batch, barcode_clean)) %>% 
  pivot_wider(names_from = treatment_batch_number, values_from = batch_donation_number) %>% 
  rename(patient = Patient,
         project = study)
```





```{r}
d_full <- d_fill %>% 
  rename(fecal_batch_date = batch) %>% 
  left_join(d_treat) %>% 
  rename(id = patient) %>% 
  mutate(project = if_else(str_detect(sample_barcode, "DoBa"), true = "donor_batch",
                           false = if_else(str_detect(sample_barcode, "DoSc"), true = "donor_screening", false = project))) %>% 
  mutate(project = if_else(str_detect(sample_barcode, "Asym"), true = "donor_batch", false = project))
```


```{r}
#write_csv(d_full, "../data/metadata/csv/sample_metadata.csv")
```

## Full metadata

```{r}
m_full_metadata <- full_join(d_full,m_tmp)
```


```{r}
m_full_metadata %>% 
  filter(stage %in% c("inclusion", "followup_30d"),
         project == "MP",
         str_detect(id, "pt")) %>% 
  group_by(id) %>%
  filter(n_distinct(stage) == 2) %>% 
  mutate(stage = factor(stage, levels = c("inclusion", "followup_30d"), labels = c("inclusion", "followup_30d"))) %>% 
  ggplot(aes(x = stage, y = pdai_score, 
             fill = stage))+
  geom_boxplot(outlier.size = 0) +
  geom_point(aes(group = id), position = position_dodge(0.2)) + #aes(x = as.factor(redcap_event_name), y = pdai_score) 
  geom_line(aes(group = id), position = position_dodge(0.2)) + 
  facet_grid(.~group)+
  theme(legend.position = "none")
  
```

```{r}
m_full_metadata %>% 
  filter(stage %in% c("inclusion", "followup_30d"),
         project == "MP",
         str_detect(id, "pt")) %>% 
  group_by(id) %>%
  filter(n_distinct(stage) == 2) %>% 
  mutate(stage = factor(stage, levels = c("inclusion", "followup_30d"), labels = c("inclusion", "followup_30d"))) %>%
  select(id, stage, group, pdai_score) %>% 
  pivot_wider(names_from = stage, values_from = pdai_score) %>% 
  mutate(diff = inclusion - followup_30d) %>% 
  group_by(group) %>% 
  summarise(mean = mean(diff),
            sd = sd(diff))

m_full_metadata %>% 
  filter(stage %in% c("inclusion", "followup_30d"),
         project == "MP",
         str_detect(id, "pt")) %>% 
  group_by(id) %>%
  filter(n_distinct(stage) == 2) %>% 
  mutate(stage = factor(stage, levels = c("inclusion", "followup_30d"), labels = c("inclusion", "followup_30d"))) %>%
  select(id, stage, group, pdai_score) %>% 
  pivot_wider(names_from = stage, values_from = pdai_score) %>% 
  mutate(diff = inclusion - followup_30d) %>% 
  group_by(group) %>% 
  summarise(mean = mean(diff),
            sd = sd(diff),
            med_incl = median(inclusion),
            med_30d = median(followup_30d))

```

```{r}
m_full_metadata %>% 
  filter(stage %in% c("inclusion", "followup_30d"),
         project == "MP",
         str_detect(id, "pt")) %>% 
  group_by(id) %>%
  filter(n_distinct(stage) == 2) %>% 
  mutate(stage = factor(stage, levels = c("inclusion", "followup_30d"), labels = c("inclusion", "followup_30d"))) %>%
  select(id, stage, group, pdai_score) %>% 
  pivot_wider(names_from = stage, values_from = pdai_score) %>% 
  mutate(diff = inclusion - followup_30d) %>% 
  group_by(diff, group) %>% 
  summarise(n = n()) %>% 
  ggplot(aes(x = as.factor(diff), y = n)) +
  geom_col() +
  facet_grid(.~group)+
  labs(x = "inclusion - 30d")
  
```

